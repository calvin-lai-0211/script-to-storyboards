name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pre-commit-checks:
    name: Pre-commit Checks
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 📦 Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: frontend/pnpm-lock.yaml

    - name: 📚 Install frontend dependencies
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile

    - name: 🧪 Run frontend tests
      working-directory: ./frontend
      run: |
        echo "🧪 Running tests..."
        pnpm run test:run

    - name: 🔍 Type check
      working-directory: ./frontend
      run: |
        echo "🔍 Running type-check..."
        pnpm exec tsc --noEmit

    - name: ✨ Lint check
      working-directory: ./frontend
      run: |
        echo "✨ Running lint..."
        pnpm run lint

    - name: 📝 PR Summary
      if: always()
      run: |
        echo "## 🔍 Pre-commit Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Tests" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Type Check" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Lint" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All pre-commit hooks passed! 🎉" >> $GITHUB_STEP_SUMMARY

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    - name: 📦 Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: frontend/pnpm-lock.yaml

    - name: 📚 Install dependencies
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile

    - name: 🏗️ Build
      working-directory: ./frontend
      run: pnpm run build
      env:
        VITE_API_BASE_URL: http://localhost:8001

    - name: 📊 Check bundle size
      working-directory: ./frontend
      run: |
        echo "## 📦 Bundle Size" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        du -sh dist/* | sort -h >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
