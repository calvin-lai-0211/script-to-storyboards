name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pre-commit-checks:
    name: Pre-commit Checks
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: frontend/pnpm-lock.yaml

    - name: ðŸ“š Install frontend dependencies
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile

    - name: ðŸ§ª Run frontend tests
      working-directory: ./frontend
      run: |
        echo "ðŸ§ª Running tests..."
        pnpm run test:run

    - name: ðŸ” Type check
      working-directory: ./frontend
      run: |
        echo "ðŸ” Running type-check..."
        pnpm exec tsc --noEmit

    - name: âœ¨ Lint check
      working-directory: ./frontend
      run: |
        echo "âœ¨ Running lint..."
        pnpm run lint

    - name: ðŸ“ PR Summary
      if: always()
      run: |
        echo "## ðŸ” Pre-commit Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Tests" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Type Check" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Lint" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All pre-commit hooks passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: frontend/pnpm-lock.yaml

    - name: ðŸ“š Install dependencies
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile

    - name: ðŸ—ï¸ Build
      working-directory: ./frontend
      run: pnpm run build
      env:
        VITE_API_BASE_URL: http://localhost:8001

    - name: ðŸ“Š Check bundle size
      working-directory: ./frontend
      run: |
        echo "## ðŸ“¦ Bundle Size" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        du -sh dist/* | sort -h >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
